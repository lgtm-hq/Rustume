# SPDX-License-Identifier: MIT
---
name: Build - Docker Image & Registry
# Builds and tests Docker image. Publishes to GHCR on main and release events.
# Uses lgtm-ci reusable Docker workflow.

"on":
  push:
    branches: [main]
    paths:
      - "docker/**"
      - "crates/**"
      - "bindings/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/docker-build-publish.yml"
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  docker:
    name: ğŸ³ Docker Build & Publish
    # yamllint disable-line rule:line-length
    uses: lgtm-hq/lgtm-ci/.github/workflows/reusable-docker.yml@v0
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    with:
      file: docker/Dockerfile
      image-name: lgtm-hq/rustume
      push: ${{ github.ref == 'refs/heads/main' || github.event_name == 'release' }}
      platforms: linux/amd64
      scan: true
      provenance: true
      sbom: true
