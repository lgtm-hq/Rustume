# SPDX-License-Identifier: MIT
---
name: Release - Auto Tag
# Automatically creates version tags when Cargo.toml version changes on main.
# Uses lgtm-ci actions for hardening and checkout.

"on":
  push:
    branches: [main]
    paths:
      - Cargo.toml

permissions:
  contents: read

jobs:
  auto-tag:
    name: ğŸ·ï¸ Create Release Tag
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 10
    defaults:
      run:
        shell: bash

    steps:
      - name: Harden Runner
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/harden-runner@v0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            objects.githubusercontent.com:443

      - name: Checkout
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/secure-checkout@v0
        with:
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Guard ensure last commit is a release bump
        id: guard
        run: ./scripts/ci/maintenance/guard-release-commit.sh

      - name: Skip if not a release bump commit
        if: steps.guard.outputs.ok != 'true'
        run: ./scripts/ci/ci-log.sh "Not a release bump commit; skipping."

      - name: Create GitHub App installation token
        if: steps.guard.outputs.ok == 'true'
        id: app-token
        # yamllint disable-line rule:line-length
        uses: actions/create-github-app-token@bf559f85448f9380bcfa2899dbdc01eb5b37be3a # v3.0.0-beta.2
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Read version from Cargo.toml
        if: steps.guard.outputs.ok == 'true'
        id: version
        run: ./scripts/ci/maintenance/auto-tag.sh read-version

      - name: Detect previous version
        if: steps.guard.outputs.ok == 'true'
        id: prev
        run: ./scripts/ci/maintenance/auto-tag.sh detect-previous

      - name: Skip if version unchanged
        if: >-
          steps.guard.outputs.ok == 'true' &&
          steps.prev.outputs.version == steps.version.outputs.version
        run: ./scripts/ci/ci-log.sh "Version unchanged; skipping."

      - name: Check if tag exists
        if: >-
          steps.guard.outputs.ok == 'true' &&
          steps.prev.outputs.version != steps.version.outputs.version
        id: check
        env:
          TAG: v${{ steps.version.outputs.version }}
        run: ./scripts/ci/maintenance/auto-tag.sh check-exists

      - name: Configure auth for push
        if: >-
          steps.guard.outputs.ok == 'true' &&
          steps.prev.outputs.version != steps.version.outputs.version &&
          steps.check.outputs.exists == 'false'
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: ./scripts/ci/maintenance/auto-tag.sh configure-auth

      - name: Create and push tag
        if: >-
          steps.guard.outputs.ok == 'true' &&
          steps.prev.outputs.version != steps.version.outputs.version &&
          steps.check.outputs.exists == 'false'
        env:
          TAG: v${{ steps.version.outputs.version }}
        run: ./scripts/ci/maintenance/auto-tag.sh create-push
