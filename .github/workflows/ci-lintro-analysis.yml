# SPDX-License-Identifier: MIT
---
name: Quality - Lint & Format
# Runs lintro quality analysis on PRs and pushes.
# Uses uv to install lintro and run checks.

"on":
  push:
    branches: [main]
    paths:
      - "**.md"
      - "**.yml"
      - "**.yaml"
      - "**.toml"
      - "**.sh"
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.json"
      - "Dockerfile*"
      - ".github/workflows/**"
      - "scripts/**"
      - ".lintro-config.yaml"
      - ".lintro-ignore"
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lintro-analysis:
    name: ðŸ› ï¸ Lintro Code Quality & Analysis
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.draft == false
    defaults:
      run:
        shell: bash
    concurrency:
      group: lint-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: "block"
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            objects.githubusercontent.com:443
            pypi.org:443
            files.pythonhosted.org:443
            astral.sh:443
            bun.sh:443
            registry.npmjs.org:443
            semgrep.dev:443

      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@6b9c6063abd6010835644d4c2e1bef4cf5cd0fca # v6.0.1
        with:
          enable-cache: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@735343c667f435a7a0eba3a4b5d829a610e33435 # v2.0.2
        with:
          bun-version: latest

      - name: Install lintro
        run: uv sync --group lint

      - name: Run Lintro Analysis
        id: lintro
        run: |
          # Disable exit-on-error to capture exit code
          set +eo pipefail
          uv run lintro chk . 2>&1 | tee chk-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          echo "CHK_EXIT_CODE=$EXIT_CODE" >> "$GITHUB_ENV"

      - name: Generate PR Comment
        if: >-
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.fork == false
        run: ./scripts/ci/ci-pr-comment.sh

      - name: Comment PR with Lintro Results
        if: >-
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.fork == false
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MARKER: "<!-- lintro-report -->"
        run: ./scripts/ci/github/ci-post-pr-comment.sh pr-comment.txt

      - name: Fail on Linting Issues
        if: (success() || failure()) && steps.lintro.outputs.exit_code != '0'
        run: |
          echo "::error::Linting checks failed (exit code: ${{ steps.lintro.outputs.exit_code }})"
          exit 1
