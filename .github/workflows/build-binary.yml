# SPDX-License-Identifier: MIT
---
name: Build - Cross-Platform Binaries
# Builds Rustume CLI and server binaries for multiple platforms.
# Uses lgtm-ci actions for setup. Called by release workflow.

"on":
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: ðŸ”¨ Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-24.04
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-24.04
            archive: tar.gz
            cross: true
          - target: x86_64-apple-darwin
            os: macos-15-intel
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-14
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

    steps:
      - name: Harden Runner
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/harden-runner@v0
        with:
          egress-policy: audit

      - name: Checkout
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/secure-checkout@v0

      - name: Setup Rust
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/setup-rust@v0
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (for cross-compilation)
        if: matrix.cross
        run: cargo install cross --locked

      - name: Build release binaries
        run: |
          BUILD_CMD="cargo"
          if [[ "${{ matrix.cross }}" == "true" ]]; then
            BUILD_CMD="cross"
          fi
          $BUILD_CMD build --release --target ${{ matrix.target }} -p rustume-cli
          $BUILD_CMD build --release --target ${{ matrix.target }} -p rustume-server

      - name: Read version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version = ' Cargo.toml \
            | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Package binaries (unix)
        if: matrix.archive == 'tar.gz'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TARGET="${{ matrix.target }}"
          STAGING="rustume-${VERSION}-${TARGET}"
          mkdir -p "$STAGING"
          cp "target/${TARGET}/release/rustume" "$STAGING/" 2>/dev/null || true
          cp "target/${TARGET}/release/rustume-server" "$STAGING/" 2>/dev/null || true
          cp README.md LICENSE "$STAGING/" 2>/dev/null || true
          tar czf "${STAGING}.tar.gz" "$STAGING"
          shasum -a 256 "${STAGING}.tar.gz" > "${STAGING}.tar.gz.sha256"

      - name: Package binaries (windows)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $TARGET = "${{ matrix.target }}"
          $STAGING = "rustume-${VERSION}-${TARGET}"
          New-Item -ItemType Directory -Path $STAGING -Force
          $CLI = "target/${TARGET}/release/rustume.exe"
          $SRV = "target/${TARGET}/release/rustume-server.exe"
          Copy-Item $CLI "$STAGING/" -ErrorAction SilentlyContinue
          Copy-Item $SRV "$STAGING/" -ErrorAction SilentlyContinue
          Copy-Item "README.md","LICENSE" "$STAGING/" -ErrorAction SilentlyContinue
          Compress-Archive -Path "$STAGING" -DestinationPath "${STAGING}.zip"
          $hash = Get-FileHash "${STAGING}.zip" -Algorithm SHA256
          $hash | Format-List | Out-File "${STAGING}.zip.sha256"

      - name: Upload artifacts
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: rustume-${{ matrix.target }}
          path: |
            rustume-*.tar.gz
            rustume-*.tar.gz.sha256
            rustume-*.zip
            rustume-*.zip.sha256
          if-no-files-found: error
          retention-days: 7
