# SPDX-License-Identifier: MIT
---
name: Test - Rust Test Suite
# Runs cargo test on PRs and pushes to main.
# Uses lgtm-ci actions for setup and PR comments.

"on":
  push:
    branches: [main]
    paths:
      - "**.rs"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/test-rust.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.rs"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/test-rust.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write
    timeout-minutes: 30
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.draft == false
    defaults:
      run:
        shell: bash
    concurrency:
      group: test-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Harden Runner
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/harden-runner@v0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            objects.githubusercontent.com:443
            raw.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            static.rust-lang.org:443
            sh.rustup.rs:443
            crates.io:443
            static.crates.io:443
            index.crates.io:443

      - name: Checkout
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/secure-checkout@v0

      - name: Setup Rust
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/setup-rust@v0

      - name: Run tests
        id: test
        run: ./scripts/ci/testing/ci-cargo-test.sh
        continue-on-error: true

      - name: Generate test PR comment
        if: github.event_name == 'pull_request'
        run: ./scripts/ci/testing/ci-test-pr-comment.sh

      - name: Comment PR with test results
        if: >-
          github.event_name == 'pull_request' &&
          github.event.pull_request.head.repo.fork == false
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/post-pr-comment@v0
        with:
          file: test-pr-comment.txt
          marker: "<!-- test-report -->"

      - name: Fail if tests failed
        if: env.TEST_EXIT_CODE != '0'
        run: ./scripts/ci/testing/fail-on-test.sh

  build:
    name: ðŸ”¨ Build Check
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    if: >-
      github.event_name != 'pull_request' ||
      github.event.pull_request.draft == false
    defaults:
      run:
        shell: bash
    concurrency:
      group: build-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Harden Runner
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/harden-runner@v0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443
            api.github.com:443
            codeload.github.com:443
            objects.githubusercontent.com:443
            raw.githubusercontent.com:443
            release-assets.githubusercontent.com:443
            static.rust-lang.org:443
            sh.rustup.rs:443
            crates.io:443
            static.crates.io:443
            index.crates.io:443

      - name: Checkout
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/secure-checkout@v0

      - name: Setup Rust
        # yamllint disable-line rule:line-length
        uses: lgtm-hq/lgtm-ci/.github/actions/setup-rust@v0

      - name: Build all crates
        run: cargo build --workspace --all-features

      - name: Build release
        run: cargo build --workspace --release
